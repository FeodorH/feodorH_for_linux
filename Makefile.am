CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2
TARGET = kubsh
SOURCES = src/main.cpp
OBJS = $(SOURCES:.cpp=.o)
PKG_NAME = kubsh
PKG_VERSION = 1.0
ARCH = amd64
BUILD_DIR = deb_build
DEB_FILE = kubsh.deb

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
all: $(TARGET)

$(TARGET): $(OBJS)
	$(CXX) $(CXXFLAGS) -o $(TARGET) $(OBJS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

clean:
	rm -f $(TARGET) $(OBJS)
	rm -rf $(BUILD_DIR)
	rm -f $(DEB_FILE) $(PKG_NAME)_*.deb

install: $(TARGET)
	install -d $(DESTDIR)/usr/bin
	install -m 755 $(TARGET) $(DESTDIR)/usr/bin/

# –¶–µ–ª—å –¥–ª—è —Å–±–æ—Ä–∫–∏ Debian –ø–∞–∫–µ—Ç–∞
deb: $(TARGET)
	@echo "Building Debian package..."
	@# –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–∫–µ—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
	@rm -rf $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/$(PKG_NAME)/DEBIAN
	@mkdir -p $(BUILD_DIR)/$(PKG_NAME)/usr/bin
	
	@# –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫
	@cp $(TARGET) $(BUILD_DIR)/$(PKG_NAME)/usr/bin/
	
	@# –°–æ–∑–¥–∞–µ–º control —Ñ–∞–π–ª
	@echo "Package: $(PKG_NAME)" > $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Version: $(PKG_VERSION)-1" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Architecture: $(ARCH)" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Maintainer: Feodor <main_user@example.com>" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Depends: libc6" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Section: utils" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Priority: optional" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo "Description: Custom shell with user management VFS" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo " A custom shell implementation that provides virtual file system" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	@echo " for user management with automatic directory monitoring." >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/control
	
	@# –°–æ–∑–¥–∞–µ–º postinst —Å–∫—Ä–∏–ø—Ç
	@echo "#!/bin/sh" > $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/postinst
	@echo "set -e" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/postinst
	@echo "echo '$(PKG_NAME) $(PKG_VERSION) installed successfully!'" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/postinst
	@echo "echo 'Run \\\"$(TARGET)\\\" to start the custom shell.'" >> $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/postinst
	@chmod 755 $(BUILD_DIR)/$(PKG_NAME)/DEBIAN/postinst
	
	@# –°–æ–±–∏—Ä–∞–µ–º .deb –ø–∞–∫–µ—Ç —Å –∏–º–µ–Ω–µ–º kubsh.deb
	@dpkg-deb --build $(BUILD_DIR)/$(PKG_NAME) $(DEB_FILE)
	
	@# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
	@rm -rf $(BUILD_DIR)
	
	@echo "‚úÖ Debian package created: $(DEB_FILE)"
	@echo "üì¶ Install with: sudo dpkg -i $(DEB_FILE)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞
check-deb:
	@if [ -f "$(DEB_FILE)" ]; then \
		echo "=== Package info ==="; \
		dpkg -I $(DEB_FILE); \
		echo "=== Package contents ==="; \
		dpkg -c $(DEB_FILE); \
	else \
		echo "Package not found. Run 'make deb' first."; \
	fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è)
install-deb: deb
	@echo "Installing package..."
	@sudo dpkg -i $(DEB_FILE) || true
	@sudo apt-get install -f -y

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
uninstall-deb:
	@sudo dpkg -r $(PKG_NAME) || true

.PHONY: all clean install deb check-deb install-deb uninstall-deb
