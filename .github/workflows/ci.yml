name: C++ Shell CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build C++ container locally
      run: |
        echo "=== Building C++ container ==="
        docker build -t kubsh-builder .
        echo "=== Container built successfully ==="
      
    - name: Build shell and create package
      run: |
        echo "=== Building shell ==="
        docker run --rm \
          -v $PWD:/workspace \
          kubsh-builder \
          bash -c "
            cd /workspace && \
            echo 'Files in workspace:' && \
            ls -la && \
            echo '=== Compiling ===' && \
            make && \
            echo '=== Creating package ===' && \
            make deb && \
            echo '=== Package created ===' && \
            ls -la *.deb
          "
      
    - name: Verify package
      run: |
        echo "=== Verifying package ==="
        ls -la *.deb
        file kubsh.deb || echo "No deb file found"
      
    - name: Run tests with sudo setup
      run: |
        echo "=== Setting up test environment ==="
        docker run --rm \
          -v $PWD:/mnt \
          --privileged \
          --user root \
          --cap-add=SYS_ADMIN \
          tyvik/kubsh_test:master \
          bash -c "
            # Устанавливаем необходимые утилиты
            apt-get update && apt-get install -y sudo adduser
            
            # Настраиваем sudo без пароля для root
            echo 'root ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            
            echo '=== Installing package ==='
            cd /mnt && apt install -y ./kubsh.deb
            
            echo '=== Running tests ==='
            cd /opt && pytest -v --log-cli-level=10
          "
