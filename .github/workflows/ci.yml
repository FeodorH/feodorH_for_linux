name: C++ Shell CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create modified test files
      run: |
        echo "=== Creating modified test files ==="
        
        mkdir -p modified_tests
        
        # Создаем test_vfs.py по частям
        echo 'import subprocess' > modified_tests/test_vfs.py
        echo 'from time import sleep' >> modified_tests/test_vfs.py
        echo 'import os' >> modified_tests/test_vfs.py
        echo 'import random' >> modified_tests/test_vfs.py
        echo 'import string' >> modified_tests/test_vfs.py
        echo '' >> modified_tests/test_vfs.py
        echo 'def random_string(length=12):' >> modified_tests/test_vfs.py
        echo '    return "".join(random.choices(string.ascii_letters + string.digits, k=length))' >> modified_tests/test_vfs.py
        echo '' >> modified_tests/test_vfs.py
        echo 'def test_vfs_add_user(kubsh, vfs):' >> modified_tests/test_vfs.py
        echo '    username = random_string().lower()' >> modified_tests/test_vfs.py
        echo '    (vfs / username).mkdir(parents=True, exist_ok=True)' >> modified_tests/test_vfs.py
        echo '    ' >> modified_tests/test_vfs.py
        echo '    # ДОБАВЛЕНА ЗАДЕРЖКА' >> modified_tests/test_vfs.py
        echo '    sleep(0.5)' >> modified_tests/test_vfs.py
        echo '    ' >> modified_tests/test_vfs.py
        echo '    user = None' >> modified_tests/test_vfs.py
        echo '    with open("/etc/passwd", "r") as f:' >> modified_tests/test_vfs.py
        echo '        for line in f:' >> modified_tests/test_vfs.py
        echo '            if line.startswith(username):' >> modified_tests/test_vfs.py
        echo '                user = line.strip().split(":")' >> modified_tests/test_vfs.py
        echo '' >> modified_tests/test_vfs.py
        echo '    assert user is not None, f"User {username} not found in /etc/passwd"' >> modified_tests/test_vfs.py
        
        echo "Test file created"
        echo "--- First 10 lines ---"
        head -10 modified_tests/test_vfs.py
      
    - name: Build and create package
      run: |
        echo "=== Building shell ==="
        make
        echo "=== Creating package ==="
        make deb
        echo "=== Package created ==="
        ls -la *.deb
      
    - name: Setup test container
      run: |
        echo "=== Setting up test container ==="
        docker run -d --name kubsh-test \
          --device /dev/fuse \
          --cap-add SYS_ADMIN \
          --security-opt apparmor:unconfined \
          --user root \
          tyvik/kubsh_test:master tail -f /dev/null
        
        docker exec kubsh-test bash -c "
          apt-get update
          apt-get install -y fuse3 adduser
          ln -sf /usr/lib/x86_64-linux-gnu/libfuse3.so /usr/lib/x86_64-linux-gnu/libfuse3.so.3
        "
        
        docker cp kubsh.deb kubsh-test:/mnt/
        docker cp modified_tests/test_vfs.py kubsh-test:/opt/test_vfs_modified.py
      
    - name: Run tests in container
      run: |
        echo "=== Running tests ==="
        docker exec kubsh-test bash -c "
          echo '=== Installing package ==='
          cd /mnt && apt-get install -y ./kubsh.deb
          
          echo '=== Running modified VFS test ==='
          cd /opt
          
          # Запускаем модифицированный тест
          python3 -m pytest test_vfs_modified.py::test_vfs_add_user -v --log-cli-level=DEBUG 2>&1
          
          echo -e '\n=== Debug info ==='
          echo 'Last 10 lines of /etc/passwd:'
          tail -10 /etc/passwd
          echo -e '\nVFS directory:'
          ls -la /opt/users/
        "
