name: C++ Shell CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build C++ container locally
      run: |
        echo "=== Building C++ container ==="
        docker build -t kubsh-builder .
        echo "=== Container built successfully ==="
      
    - name: Build shell and create package
      run: |
        echo "=== Building shell ==="
        docker run --rm \
          -v $PWD:/workspace \
          kubsh-builder \
          bash -c "
            cd /workspace && \
            echo '=== Compiling ===' && \
            make && \
            echo '=== Creating package ===' && \
            make deb && \
            echo '=== Package created ===' && \
            ls -la *.deb
          "
      
    - name: Setup test container (как у товарища)
      run: |
        echo "=== Setting up test container ==="
        # Запускаем контейнер в фоне
        docker run -d --name kubsh-test \
          --device /dev/fuse \
          --cap-add SYS_ADMIN \
          --security-opt apparmor:unconfined \
          --user root \
          tyvik/kubsh_test:master tail -f /dev/null
        
        # Устанавливаем зависимости
        docker exec kubsh-test bash -c "
          apt-get update
          apt-get install -y fuse3 adduser
          ln -sf /usr/lib/x86_64-linux-gnu/libfuse3.so /usr/lib/x86_64-linux-gnu/libfuse3.so.3
        "
        
        # Копируем пакет в контейнер
        docker cp kubsh.deb kubsh-test:/mnt/
      
    - name: Run tests in container
      run: |
        echo "=== Running tests ==="
        docker exec kubsh-test bash -c "
          echo '=== Installing package ==='
          cd /mnt && apt-get install -y ./kubsh.deb
          
          echo '=== Checking kubsh permissions ==='
          ls -la /usr/bin/kubsh
          
          echo '=== Running tests ==='
          cd /opt && pytest -v --log-cli-level=DEBUG
        "
      
    - name: Cleanup
      run: |
        docker stop kubsh-test || true
        docker rm kubsh-test || true
