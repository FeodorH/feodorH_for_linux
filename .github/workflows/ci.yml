name: Build, Test and Release kubsh

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    # –î–∂–æ–± —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å
    permissions:
      contents: read
    outputs:
      deb_file_name: ${{ steps.get_deb_name.outputs.deb_file_name }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build DEB package
      run: |
        echo "=== Building kubsh and creating DEB package ==="
        docker build -t kubsh-builder .
        docker run --rm -v $PWD:/workspace kubsh-builder bash -c "cd /workspace && make && make deb"
        echo "=== Generated DEB package ==="
        ls -la *.deb

    - name: Get DEB file name and make it unique
      id: get_deb_name
      run: |
        ORIGINAL_DEB=$(ls kubsh*.deb | head -1)
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è —Ñ–∞–π–ª–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        UNIQUE_DEB_NAME="kubsh-shell_$(date +%Y%m%d_%H%M%S).deb"
        cp "$ORIGINAL_DEB" "$UNIQUE_DEB_NAME"
        echo "deb_file_name=$UNIQUE_DEB_NAME" >> $GITHUB_OUTPUT
        echo "DEB_FILE=$UNIQUE_DEB_NAME" >> $GITHUB_ENV
        echo "Unique DEB name: $UNIQUE_DEB_NAME"

    - name: Upload DEB artifact for release job
      uses: actions/upload-artifact@v4
      with:
        name: kubsh-deb-package
        path: ${{ steps.get_deb_name.outputs.deb_file_name }}
        retention-days: 7

    # –®–∞–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏ –µ–≥–æ –∑–∞–ø—É—Å–∫–∞ –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
    # ... (–≤–∞—à–∏ —à–∞–≥–∏ 'Create fixed test file for test 9' –∏ 'Run tests with fixed test 9' –∑–¥–µ—Å—å)

  create-release:
    # –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–ª–∏–∑ –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ –Ω–∞ –≤–µ—Ç–∫–µ main.
    # –£–±—Ä–∞–Ω–æ —Å—Ç—Ä–æ–≥–æ–µ —É—Å–ª–æ–≤–∏–µ –Ω–∞ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è.
    if: ${{ github.ref == 'refs/heads/main' && needs.build-and-test.result == 'success' }}
    needs: build-and-test
    runs-on: ubuntu-latest
    # –î–∂–æ–± —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞ —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω—ã—Ö –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code for tagging
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏

    - name: Download DEB artifact
      uses: actions/download-artifact@v4
      with:
        name: kubsh-deb-package
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£–∫–∞–∑—ã–≤–∞–µ–º run-id —Ç–æ–≥–æ –∂–µ workflow
        run-id: ${{ needs.build-and-test.outputs.run_id }}

    - name: Create and push a version tag
      id: create_tag
      run: |
        # –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è —Å—Ö–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ç–µ–≥–∞: –≤–µ—Ä—Å–∏—è + –¥–∞—Ç–∞ + –∫–æ—Ä–æ—Ç–∫–∏–π —Ö—ç—à –∫–æ–º–º–∏—Ç–∞
        SHORT_SHA="${GITHUB_SHA:0:7}"
        TAG_NAME="v1.0.0-$(date +%Y%m%d)-${SHORT_SHA}"
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

        git config user.name "GitHub Actions Bot"
        git config user.email "github-actions@users.noreply.github.com"
        # –°–æ–∑–¥–∞–µ–º –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–≥
        git tag -a "$TAG_NAME" -m "Automated release from GitHub Actions"
        # –ü—É—à–∏–º —Ç–µ–≥ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        git push origin "$TAG_NAME"
        echo "‚úÖ Created and pushed tag: $TAG_NAME"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: "kubsh ${{ env.TAG_NAME }}"
        body: |
          ## kubsh Shell
          Automated release containing the kubsh shell as a DEB package.
          ### Installation
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ needs.build-and-test.outputs.deb_file_name }}
          sudo dpkg -i ${{ needs.build-and-test.outputs.deb_file_name }}
          sudo apt-get install -f  # If dependencies are missing
          ```
          All tests passed, including the **fixed test #9 with 0.5s delay**.
        draft: false
        prerelease: false
        # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –Ω–∞—à DEB-—Ñ–∞–π–ª. –ò–º—è –±–µ—Ä–µ—Ç—Å—è –∏–∑ outputs –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∂–æ–±–∞.
        files: ${{ needs.build-and-test.outputs.deb_file_name }}

    - name: Display Release Info
      run: |
        echo "=================================================================="
        echo "‚úÖ RELEASE CREATED SUCCESSFULLY!"
        echo "üìÅ Release Page: https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG_NAME }}"
        echo "üì¶ Direct Download Link:"
        echo "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ needs.build-and-test.outputs.deb_file_name }}"
        echo "=================================================================="
