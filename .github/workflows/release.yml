name: Create Release

on:
  push:
    branches: [ main ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build DEB package
      id: build
      run: |
        echo "=== Building kubsh ==="
        docker build -t kubsh-builder .
        docker run --rm -v $PWD:/workspace kubsh-builder bash -c "cd /workspace && make && make deb"
        # Просто проверяем, что файл создан, и фиксируем его имя
        DEB_NAME=$(ls kubsh*.deb | head -1)
        echo "DEB_NAME=$DEB_NAME" >> $GITHUB_ENV
        echo "✅ Package built: $DEB_NAME"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0
        name: Release v1.0.0
        body: |
          Первый стабильный релиз kubsh.
          
          ### Установка
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/v1.0.0/kubsh.deb
          sudo dpkg -i kubsh.deb
          ```
        draft: false
        prerelease: false
        # Ключевое исправление: указываем конкретное имя файла
        files: ${{ env.DEB_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
